#!/bin/bash

show_header() {
    echo -e "\033[97m# =------------------------------------==============+===---------------------------------------------\033[0m"
    echo -e "\033[97m# -----------------------------------=====--------------====------------------------------------------\033[0m"
    echo -e "\033[97m# --------------------------------=====--------------------===----=====-------------------------------\033[0m"
    echo -e "\033[97m# -------------------------------====--------=+**=-----------==--=----===-----------------------------\033[0m"
    echo -e "\033[97m# ------------------------------===---------+*###*------------==========-----------------=+=----------\033[0m"
    echo -e "\033[97m# -----------------------------===----------*##*+---------------==----------=====---==-=++==**--------\033[0m"
    echo -e "\033[97m# ----------------------------===--------------------------------=-------==-------+++**=-+#*++*=------\033[0m"
    echo -e "\033[97m# ----------------------------===-----=*+------------------------==---===-------+#*-:-+#+--*#====-----\033[0m"
    echo -e "\033[97m# ----------------------------===------+#+=----------------------==-===--------*##*+:::+#=--**:--=----\033[0m"
    echo -e "\033[97m# -----------=============----==--------+#*=-------=**##+--------====---------*####*=:::+#=-+=:::-==--\033[0m"
    echo -e "\033[97m# -------===---------------======--------=*#=-----=*####=--------===--------:+*#####*-:::+#=-:::::-=--\033[0m"
    echo -e "\033[97m# -----==--:::::::::::-------====---------=*#+-----=++=----------==----------*#######*-:::*#-::::::-=-\033[0m"
    echo -e "\033[97m# ---==--:::::::---:::--------===-----------*#*-----------------===----------*########+:::-**-=+=:::-=\033[0m"
    echo -e "\033[97m# --=--:::::::-*##**=----------===-----------+#*----------------==----------:+*########=:::-#+-=*+-=+=\033[0m"
    echo -e "\033[97m# -=-::::::::::=*###*----+*#+---===----------------------------=+=------------*########*=:::=#=-=#=-*= \033[0m"
    echo -e "\033[97m# =-:::::::::::::-------*###-----===--------------------------====-------------*########*-::-**-=*=-*= \033[0m"
    echo -e "\033[97m# =-:::::::::::::::----+###+-------===----------------------=======-------------+########*-::=#==*-=+=\033[0m"
    echo -e "\033[97m# -=-::::::::::::::::---=####---------=====----------------=====--===---------------=*######*--=#=--:-\033[0m"
    echo -e "\033[97m# -=-:::::::::::-::-:---+##%=----------=========------========-----===-----------------=+**#**+=-:::-=\033[0m"
    echo -e "\033[97m# -=-::::::::=*###**=---+##%-----------=--=================--------=+==-------------------::::::::--==-\033[0m"
    echo -e "\033[97m# -=-::::::::-*####+---*##%-----------==--============--------------=+==-------------------::::::--==--\033[0m"
    echo -e "\033[97m# =-::::::::::------=*#%+----------=====---------------------------==+==-----------------------==-----\033[0m"
    echo -e "\033[97m# =--:::::::::::----=*##------====----------------------------------======-------------------==-----=-\033[0m"
    echo -e "\033[97m# -=--::::::::::-----=#=---===----------==========------------------==--======------------====-------\033[0m"
    echo -e "\033[97m# --==--::::::::--------===----=========-=========------------============-----========----::==------\033[0m"
    echo -e "\033[97m# ----=----::::------===----=========-----==================----------------====------------:-==------\033[0m"
    echo -e "\033[97m# ------=----------==-----=======---======--------===-----------------------------------=+=-:-==-----\033[0m"
    echo -e "\033[97m# =-------===-----==-========---====---------===-----------------===-----------------======-:-==-----\033[0m"
    echo -e "\033[97m# -----------=-============--===------------=----------==========---==--=====--------=---+---:==-----\033[0m"
    echo -e "\033[97m# -----------=-:---======---=----------======----=---====--=====----==----------------=+=----:-=-----\033[0m"
    echo -e "\033[97m# -----------=-:-----===-----------=====----==--=====---------------==-------------------------=-----\033[0m"
    echo -e "\033[97m# -----------=-:-----------------==----==----=====------------------==-------------------------=---=-\033[0m"
    echo -e "\033[97m# -----------==::-----------------------==----====------------------==-------------------------=-----\033[0m"
    echo -e "\033[97m# -----------==-:-----------------------==-----===------------------==-------------------------=-----\033[0m"
    echo -e "\033[97m# ------------=-:------------------------=-----====------------------=------------------------==-=-=-\033[0m"
    echo -e "\033[97m# ------------==-------------------------==-----===------------------==-----------------------==-----\033[0m"
    echo -e "\033[97m# -------------=-:------------------------=-----===------------------==-----------------------===---=-\033[0m"
    echo -e "\033[97m# --------------=-------------------------==-----===-----------------==-----------------------=------\033[0m"
    echo -e "\033[97m# --------------==-------------------------============--------------==----------------------==-----=-\033[0m"
    echo -e "\033[97m# ---------------=----------------------====-------------------------==----------------------==----=-=\033[0m"
    echo -e "\033[97m# ----------------=------------------===-----===---------------------==---------------------==-------\033[0m"
    echo -e "\033[97m# -----------------=----------------==----============--------------===---------------------==-------\033[0m"
    echo -e "\033[97m# -----------------==--------------==---===--==----====================--------------------==--------\033[0m"
    echo -e "\033[97m# ------------------==-------------=----==----=--===-----===-----------====----------------===-------\033[0m"
    echo -e "\033[97m# -------------------==------------==---==---===-------=-----------------------------------==--=-----\033[0m"
    echo -e "\033[97m# ---------------------=-----------===--=====--------==-----=======-----------------------==-=-=-----\033[0m"
    echo -e "\033[97m# ----------------------=-----------===-==--------=====----==----=======-----------------===---------\033[0m"
    echo -e "\033[97m# -----------------------==-----========-==-----===--=----====---==-=======-------------==-----------\033[0m"
    echo -e "\033[97m# ------------------------==--=========---==---===---==---==-==--------=====-------====-=--==--------\033[0m"
    echo -e "\033[97m# -------------------------==---=======---==-=====---==---==-==-------==----======-----==---==-------\033[0m"
    echo -e "\033[97m# --------------------------===---------===---------===---==-==-----=======--===-------==--===-------\033[0m"
    echo -e "\033[97m# ----------------------------===------===---==---===--==--=--==---===--------------------=-----------\033[0m"
    echo -e "\033[97m# ------------------------------===----===---===-----====-------==----------------------------=------\033[0m"
    echo -e "\033[97m# --------------------------------===--===----=---===--------===--------------------------=-====---\033[0m"
    echo -e "\033[97m# -----------------------------------===------===------==-----=------------------------------------\033[0m"
    echo -e "\033[97m# ===================================----------===--------==------------------------------------\033[0m"
}

# Вызываем функцию отображения заголовка
show_header

# Прекращаем выполнение при ошибках
set -e

# Имя Docker-образа
IMAGE_NAME="titan_image"  # Новый образ, созданный на основе Ubuntu

# Имя для контейнера
CONTAINER_PREFIX="titan"

# Папка для хранения Machine ID
MACHINE_ID_DIR="machine_ids"
mkdir -p "$MACHINE_ID_DIR"

# Создаём Dockerfile
echo "Создаём Dockerfile..."

cat <<EOF > Dockerfile
# Используем базовый образ Ubuntu
FROM ubuntu:22.04

# Установка необходимых пакетов
RUN apt-get update && apt-get install -y \\
    apt-transport-https \\
    ca-certificates \\
    curl \\
    software-properties-common \\
    uuid-runtime \\
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - \\
    && add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable" \\
    && apt-get update \\
    && apt-get install -y docker-ce docker-ce-cli containerd.io \\
    && curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)" -o /usr/local/bin/docker-compose \\
    && chmod +x /usr/local/bin/docker-compose \\
    && usermod -aG docker root

# Запуск демона Docker
CMD ["sh", "-c", "dockerd & tail -f /dev/null"]
EOF

echo "Dockerfile создан."

# Сборка Docker-образа
echo "Сборка Docker-образа $IMAGE_NAME..."
docker build -t "$IMAGE_NAME" .

# Запрос количества контейнеров
read -p "Введите количество контейнеров для создания: " CONTAINER_COUNT

# Проверка на корректность ввода
if [[ ! "$CONTAINER_COUNT" =~ ^[0-9]+$ ]]; then
    echo "Ошибка: введите число."
    exit 1
fi

# Цикл для создания контейнеров
for ((i=1; i<=CONTAINER_COUNT; i++)); do
    # Генерация уникального Machine ID для контейнера
    MACHINE_ID_FILE="$MACHINE_ID_DIR/machine_id_$i"
    uuidgen > "$MACHINE_ID_FILE"
    MACHINE_ID=$(cat "$MACHINE_ID_FILE")

    # Генерация уникального имени контейнера
    container_name="${CONTAINER_PREFIX}${i}"

    # Проверка на существование контейнера с таким именем
    while docker ps -a --format '{{.Names}}' | grep -q "^${container_name}$"; do
        i=$((i + 1))  # Увеличиваем i для создания нового имени
        container_name="${CONTAINER_PREFIX}${i}"  # Обновляем имя контейнера
    done

    # Создание и запуск Docker-контейнеров с привилегиями
    if docker run -d --privileged --name "$container_name" --env MACHINE_ID="$MACHINE_ID" "$IMAGE_NAME"; then
        echo "Контейнер ${container_name} запущен с Machine ID $MACHINE_ID"
    else
        echo "Ошибка при запуске контейнера ${container_name}. Возможно, образ недоступен."
    fi
done

echo "Создано $CONTAINER_COUNT контейнеров."

# Начинаем настройку контейнеров
echo "Начинаем настройку контейнеров..."

# Получаем список контейнеров с именем titan*
containers=$(docker ps -a --format '{{.Names}}' | grep "^${CONTAINER_PREFIX}[0-9]*$")

for container in $containers; do
    echo "Обработка контейнера $container"

    # Проверяем, запущен ли контейнер
    is_running=$(docker ps --format '{{.Names}}' | grep "^$container$")

    if [ -z "$is_running" ]; then
        echo "Контейнер $container не запущен. Запускаем..."
        docker start "$container"
    else
        echo "Контейнер $container уже запущен."
    fi

    # Проверяем, есть ли запущенные Docker-контейнеры внутри контейнера titan*
    running_containers=$(docker exec "$container" docker ps -q 2>/dev/null)

    if [ -z "$running_containers" ]; then
        echo "Внутри контейнера $container нет запущенных Docker-контейнеров. Выполняем настройки..."

        # Выполняем команды внутри контейнера titan*
        echo "Выполняем docker pull nezha123/titan-edge внутри $container"
        docker exec "$container" docker pull nezha123/titan-edge

        echo "Создаём директорию ~/.titanedge внутри $container"
        docker exec "$container" mkdir -p /root/.titanedge

        echo "Запускаем nezha123/titan-edge внутри $container"
        docker exec "$container" docker run --network=host -d -v /root/.titanedge:/root/.titanedge nezha123/titan-edge

        # Пауза 3 секунды для создания файла config.toml
        echo "Ожидание 3 секунд для создания config.toml"
        sleep 3

        # Извлекаем номер из имени контейнера
        port_number=$(echo "$container" | grep -o '[0-9]\+')
        port=$((1234 + port_number))

        # Заменяем порт в файле config.toml внутри контейнера
        echo "Изменяем порт на $port в файле config.toml внутри $container"
        docker exec "$container" sed -i "s/#ListenAddress = \"0.0.0.0:1234\"/ListenAddress = \"0.0.0.0:$port\"/" /root/.titanedge/config.toml

        # Запрашиваем Identity code у пользователя
        echo -n "Введите Identity code для контейнера $container: "
        read -r IDENTITY_CODE

        # Проверяем, что пользователь ввёл код
        if [ -z "$IDENTITY_CODE" ]; then
            echo "Ошибка: Identity code не может быть пустым. Пропускаем контейнер $container."
            continue
        fi

        # Выполняем команду bind внутри контейнера без опции -it
        echo "Выполняем команду bind внутри $container"
        docker exec "$container" docker run --rm -v /root/.titanedge:/root/.titanedge nezha123/titan-edge bind --hash="$IDENTITY_CODE" https://api-test1.container1.titannet.io/api/v2/device/binding

        echo "Настройка контейнера $container завершена."
    else
        echo "Внутри контейнера $container уже запущены Docker-контейнеры."
    fi

    echo "--------------------------------------------"
done

echo "Все контейнеры настроены."
